<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org">
<head th:insert="student/fragments :: headFragment">
<title id="pageTitle">AIBTGlobal Student - Change of
	Qualification</title>
</head>

<body>
	<nav th:replace="student/fragments :: navFragment"></nav>
	<form id="coqForm" method="post"
		th:action="${#httpServletRequest.requestURI}"
		th:object="${coQApplication}">
		<div class="bottom" style="padding-bottom: 300px">
			<div class="">
				<p class="rightTit">Change of Qualification</p>

				<div class="rightcon">
					<div class="two">
						<p>
							<b>Name:</b><span
								th:text="|${userObj.firstname} ${userObj.lastname}|">
						</p>

						<p>
							<b>ID:</b>[[${userObj.id}]]
						</p>
					</div>

					<div class="two">
						<p>
							<b>Current Campus:</b>[[${userObj.campus}]]
						</p>


					</div>
					<div class="one">

						<p>
							<b>If you want to choose other campus'courses,please <a
								href="/student/coc">change campus</a> first
							</b>

						</p>
					</div>
					<div class="xieyi d-none three">
						<p style="width: 20px">
							<b style="display: inline-block"><input type="checkbox"
								id="tongyi" name="tongyi" value="yes"></b>
						</p>

						<p style="width: 90%">
							<label for="tongyi"> This is not your first change
								qualification, this qualification need $500. </label>
						</p>
					</div>

					<div class="one">
						<p>
							<b>Current course:</b><span th:text="${session.course}"></span>
						</p>
					</div>
					<div class="two">
						<p>
							<b>Please choose the course you want to change:</b> <b>(You
								can choose more than one courses)</b>

						</p>
						<div class="two">

							<b>Intent courses:</b> <select id="course" style="float: left;width: 50%;">
								<option>--Select Courses--</option>

							</select>
							<p>
								<input type="button" class="btn btn-success" id="add_new"
									value="Add" style="padding-top: 0px;padding-bottom: 0; margin-bottom: 10px;">
							</p>
						</div>


					</div>

					<div class="two">


						<div id="current_course" style="float: left;width: 50%;">


							<div th:each="c: ${courseenrolledlist}" style="margin-top: 10px;margin-bottom: 10px;">
								<input type="checkbox" name="chosen1" th:text="${c}" >
							</div>

						</div>

                       <div class="tbl_float">

						<table id="new_courses" class="tbl_code_with_mark ">
							<thead>
								<tr>


									

									<th></th>
								</tr>
							</thead>
							<tbody id="stable">

							</tbody>
						</table>


                      </div>


					</div>





					<div class="one">
						<p>
							<b>Intake Month:</b> <select id="eq_num"
								th:field="*{intakeMonth}"></select>
						</p>
					</div>





					<div class="bootbtn">

						<input type="button" class="btn btn-success" id="coq_next"
							value="Next">

					</div>

					<div>
						<input type="hidden" id="changedCourses"
							th:field="*{changedCourses}"> <input type="hidden"
							id="originalCourses" th:field="*{originalCourses}"> <input
							type="hidden" id="ifcheckagreement">
					</div>


				</div>
			</div>
		</div>



	</form>

	<script th:inline="javascript">
        $(document).ready(function(){
        	   $('#dropdown-list').removeClass("d-none");
               var current_course = [[${courseList}]];
             
               
               var course_list = [[${userObj.enrolledCourse}]];
               
               var courseArray = course_list.split(',');
             
               var max = 0;
               for (k = 0; k < courseArray.length; k++){
            	   temp = courseArray[k].substring(3,4);
            	   var tempnumber = parseInt(temp);
            	   if (tempnumber > max) {
            		   max = tempnumber;
            	   }
                   
               }
               $('input[name="tongyi"]').click(function(){
                   if(this.checked){
                	   $('#ifcheckagreement').attr("value", 'agree');
                   }
                  
               });
               
             
               var db_courses = $.grep(current_course, function(v) {
            
                   return v.campus === [[${userObj.campus}]];
               });
             
               var result = db_courses.map(a => a.courseName);
             
               result=Array.from(new Set(result));
           
            
               for (k = 0; k < result.length; k++){
               	$('#course').append("<option value='" + result[k]+ "'>" + result[k] + "</option>");
               }
               var members= new Array();
               members=course_list.split(","); 
              // var members = ["1","2","3"];
             // console.log(members);
            //   var thisdiv = $('#current_course');
            //   $.each(members, function(index, item){
              // 	thisdiv.append("<input type='checkbox' name='chosen'>"+ item + "<br>");
             //  })
               //if platform amount>0 if yes, show checkbox
               if ([[${userObj.platformAmount}]] > 0) {
            	   $('.xieyi').removeClass('d-none');
               }
              
              
           });
           $('#coq_next').click(function(){
           
       	   var wantToChangeCourses = new Array();
       	   var checkboxValue= new Array();
       	   var checkboxText= new Array();
       	   var checkboxStr=document.getElementsByName("chosen1");  
       	   for(var i=0; i<checkboxStr.length; i++){
       		if(checkboxStr[i].checked){
       	            //alert(checkboxStr[i].value+","+checkboxStr[i].nextSibling.nodeValue);
       		    checkboxValue.push(checkboxStr[i].value);
                           checkboxText.push(checkboxStr[i].nextSibling.nodeValue);
                           
       		 }
       		
       	   }
       	 
       	    $('#originalCourses').attr("value", checkboxText.join(","));
              
               
               $("#stable").find("tr").each(function(){
              
                   var tdArr = $(this).children("td")[0].innerHTML;
                  
                   wantToChangeCourses.push(tdArr);
                  
                });
              
               $('#changedCourses').attr("value", wantToChangeCourses.join(", "));
            
               //get original enroll courses
               var orienrollc = [[${courseenrolledlist}]];
                
              
            
            
              var deletecourses = $('#originalCourses').val().split(',');
              //trim
          
              //for loop rewrite deletecourses
              var deletenewcourse = new Array();
              for (i=0; i<deletecourses.length;i++){
            	  deletenewcourse.push(deletecourses[0].trim());
              }
            
              //find restcourses
              // get the rest courses
              var restcourses = orienrollc.filter(function(v){ return deletenewcourse.indexOf(v) == -1 })
              restcourses = wantToChangeCourses.concat(restcourses);
          
             
              //find rest courses ID from course list
              var mynewArray = new Array();
              var currentLevel = 0;
              for(i=0;i<restcourses.length;i++){
            	  mynewArray = [[${courseList}]].filter(x => x.courseName === restcourses[i]);
            	  var tempLevel = parseInt(mynewArray[0].courseID.substring(3,4))
            	  if (mynewArray[0].courseName.indexOf("+")>-1){
            		  tempLevel = parseInt(mynewArray[0].courseID.substring(12,13))
            	  }
            	  if (tempLevel>currentLevel) {
            		  currentLevel = tempLevel;
            	  }
            	 
            	
              }
           
              //get enrolled courses max level
              var course_list = [[${userObj.enrolledCourse}]];
              
              var courseArray = course_list.split(',');
              courseArray.push([[${userObj.currentCourseCode}]]);
             
          
              var max = 0;
              for (k = 0; k < courseArray.length; k++){
           	   temp = courseArray[k].substring(3,4);
           	 if (courseArray[k].indexOf("/")>-1){
           		temp = courseArray[k].substring(12,13);
       	  }
           	   var tempnumber = parseInt(temp);
           	   if (tempnumber > max) {
           		   max = tempnumber;
           	   }
                
              }
        

              if ([[${userObj.platformAmount}]] > 0) {
            	  if ($('#ifcheckagreement').val() == ''){
            		  alert("please agree change fee");
            		  return
            	  }
            	 
              }
              
              
               if(($('#originalCourses').val() != '')&&($('#changedCourses').val() != '')){
            	   if(currentLevel<max){
            		   alert("The max level of courses can not be lower");
            		   return
            	   }
            	   
               	coqForm.submit();
               }else {
               	alert("please choose courses you want to withdraw and courses you want to choose");
               }
                 
               
           });
           
           $('#add_new').click(function(){
           	var intentCourses = [];
           	if($('#new_courses') != '')
           	 var selected_option =  $("#course").find("option:selected").text();
           	
           	 $("#course").find("option:selected").attr('disabled', true);
           	 mynewArray = [];
         
           	 $('#selecteditem').attr("value",selected_option);
           	
           	 var content = "<tr>" +
                "<td>" +selected_option+"</td>"+
                "<td>" +
                    "<button type='button' class='btn btn-delete' id='DeleteButton'>Delete</button>"+
                "</td>" +
            "</tr>";
           	// $('#new_courses').after(content);
           	$('#new_courses tbody').append(content);
           	
           	
           	 $('#course').each(function (i, j) {
           		    var options = $(j).find("option");
           	        options.attr("selected", false);
           	        options.first().attr("selected", true);
                })
           });
           
           $('#delete').click(function(){
               
           	$('#course').each(function (i, j) {
                   $(j).find("option:selected").attr("selected", false);
                   $(j).find("option").first().attr("selected", true);
               })
          });
           
          $(document).on('click',".btn-delete",function(e){
       	 
       	   var r = $(this).closest('tr').remove();
       	
       	   var value = $(this).closest('tr').children("td")[0].innerHTML;
       	  
       		   
       		   $('#course option:contains('+ value +')').each(function(){
       			  
       			    if ($(this).text() == value) {
       			    	
       			        $(this).attr('disabled', false);
       			        return false;
       			    }
       			    return true;
       			});	   
          
       	   
          });
          $("#checkAll").click(function(){
       	    $('input:checkbox').not(this).prop('checked', this.checked);
       	});
          
          // Dynamic add select's options
          $(document).ready(function(){
              var dateObj = new Date();
              var current_year = dateObj.getFullYear();
              var end_year = dateObj.getFullYear() + 1;
              var current_month = dateObj.getMonth()+1;  // because January is 0
              var obj=document.getElementById('eq_num');
               
              $('#eq_num').empty();
              for(var i = current_year; i <= end_year; i++)
              {
                 for (var j = 1; j <= 12; j++)
                 {
                     if(j == current_month && i == current_year)
                     {
                          if(j<10){
                              obj.options.add(new Option(i+"-"+j,i+"-0"+j),true);
                          }else{
                              obj.options.add(new Option(i+"-"+j,i+"-"+j),true);
                          }
                          continue;
                     }
                     if(j > current_month && i == current_year)
                     {
                         if(j<10){
                              obj.options.add(new Option(i+"-"+j,i+"-0"+j));
                         }else{
                              obj.options.add(new Option(i+"-"+j,i+"-"+j));
                         }
                         continue;
                     }
                     if(i == end_year)
                     {
                          if(j<10){
                              obj.options.add(new Option(i+"-"+j,i+"-0"+j));
                          }else{
                              obj.options.add(new Option(i+"-"+j,i+"-"+j));
                          }
                          continue;
                     }
                 }
              }
              
              //  Set select current Month
              $(obj).find("option").each(function(){
                  if ($(this).val() === current_year+"-"+(current_month))
                  {
                      $(this).attr("selected",true)
                  }
              });
       });
       
      
      
      
        
       
        
        </script>
</body>
</html>